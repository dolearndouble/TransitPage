<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check App Installation</title>
    <script>
        // 获取 URL 参数
        function getQueryParam(param) {
            var urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function checkAppInstalled(appScheme, callback) {
            var hidden = false;

            // 监听 visibilitychange 事件
            function handleVisibilityChange() {
                if (document.hidden) {
                    hidden = true;  // 页面被隐藏，应用可能已经被打开
                }
            }
            document.addEventListener('visibilitychange', handleVisibilityChange);

            if (navigator.userAgent.match(/(iPhone|iPod|iPad)/)) {
                var iframe = document.createElement("iframe");
                iframe.src = appScheme + "://";
                iframe.style.display = "none";
                document.body.appendChild(iframe);

                setTimeout(function () {
                    document.body.removeChild(iframe);
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                    callback(hidden); // 如果页面未被隐藏，则认为应用未安装
                }, 2000);
            } else if (navigator.userAgent.match(/android/i)) {
                var androidLink = document.createElement("a");
                androidLink.href = appScheme + "://";
                androidLink.style.display = "none";
                document.body.appendChild(androidLink);

                setTimeout(function () {
                    document.body.removeChild(androidLink);
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                    callback(hidden);
                }, 2000);
            } else {
                callback(false);  // 如果不是 iOS 或 Android，则认为未安装
            }
        }

        window.onload = function() {
            // 获取传递的 appScheme 和 shareUrl 参数
            var appScheme = getQueryParam("appScheme");
            var shareUrl = getQueryParam("shareUrl");

            if (appScheme) {
                // 检查应用是否安装
                checkAppInstalled(appScheme, function(isInstalled) {
                    if (isInstalled) {
                        alert("应用已安装");
                        window.location.href = appScheme;
                    } else {
                        alert("应用未安装，跳转到分享链接...");
                        if (shareUrl) {
                            window.location.href = shareUrl;
                        } else {
                            alert("跳转链接出错,链接参数可能为空");
                        }
                    }
                });
            } else if (shareUrl) {
                // 如果没有提供 appScheme，直接跳转到 shareUrl
                window.location.href = shareUrl;
            } else {
                alert("没有提供 appScheme 和 shareUrl 参数！");
            }
        }
    </script>
</head>
<body>
    <h1>Check App Installation</h1>
</body>
</html>
